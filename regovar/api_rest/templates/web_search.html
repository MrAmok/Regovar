<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Regovar </title>


    <!-- Base -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
    <script type="text/javascript" src="https://code.jquery.com/jquery-migrate-3.0.0.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


    <style>
        h1 {
            margin-top: 100px;
        }
        code {
            margin-left:-4px;
        }

        i {
            color: #999;
        } 
        input {
            font-family: monospace;
        }
        input[type=text] {
            display: block;
            width:100%;
        }
        textarea {
            font-family: monospace;
        }

        /* Loading indicator */
        .loader {
            border: 10px solid #f3f3f3;     /* Light grey */
            border-top: 10px solid #3498db; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* JSON highlighting */
        pre {outline: 1px solid #ccc; padding: 5px; margin: 5px; }
        .string { color: green; }
        .number { color: darkorange; }
        .boolean { color: blue; }
        .null { color: magenta; }
        .key { color: red; }

        /* WS log table */
        .ws_logs {
          width: 90%;
          table-layout: fixed;
          border-collapse: collapse;
          
          
        }
        .ws_logs tbody tr:nth-child(even) 
        {
            background-color: #eee;
        }
        #searchbar 
        {
            background-image: url(https://www.w3schools.com/css/searchicon.png);
            background-position: 10px 12px;
            background-repeat: no-repeat;
            width: 100%;
            font-size: 16px;
            padding: 12px 20px 12px 42px;
            border: 1px solid #ddd;
            margin-bottom: 12px;
            margin-top: 50px;
        }
        

    </style>
</head>

<body style="background: #efeff1">
    <nav class="navbar navbar-default navbar-fixed-top navbar-inverse">
        <div class="container">
            <div class="navbar-header">
                <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
            </div>
            <div id="navbar" class="navbar-collapse collapse" aria-expanded="false" style="height: 1px;">
                <ul class="nav navbar-nav">
                    <li class="active"><a data-toggle="tab" href="http://{{ hostname }}"><i class="glyphicon glyphicon-home"></i> Regovar</a></li>
                </ul>
            </div><!--/.nav-collapse -->
        </div>
    </nav>

    <div class="container" role="main">
        <div style="margin-top:70px; text-align: center;">
            
            <pre id="json"/>
            </pre>
            <pre />
            </pre>


        </div>
        <p style="margin-top:100px; text-align: center;">
            <a href="http://regovar.org" target="_blanck">Regovar.org</a> - 
            <a href="http://regovar.readthedocs.io/fr/latest/" target="_blanck">Documentation</a>
        </p>
    </div>


    <script>
        var rootURL = "http://{{ hostname }}";
        var data = {{ data }};
        var error = {{ error }};
        var path = {{ path }};



        function syntaxHighlight(json) 
        {
            if (typeof json != 'string') 
            {
                 json = JSON.stringify(json, undefined, 4);
            }
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) 
            {
                var cls = 'number';
                if (/^"/.test(match)) 
                {
                    if (/:$/.test(match)) 
                    {
                        cls = 'key';
                    } 
                    else 
                    {
                        cls = 'string';
                    }
                } 
                else if (/true|false/.test(match)) 
                {
                    cls = 'boolean';
                } 
                else if (/null/.test(match)) 
                {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }
        function clear_container(id)
        {
            $('#'+id).html("");
            // 
        }
        function buildProgressBar(percentage, containerId) 
        {
            var html = "<div class='progress'>\
                        <div class='progress-bar progress-bar-striped active' role='progressbar' aria-valuenow='" + percentage + "' aria-valuemin='0' aria-valuemax='0' \
                            style='min-width: 2em; width: " + percentage + "%;'>\
                            " + percentage + "% \
                        </div>\
                    </div>";

            if (containerId !== null)
            {
                $("#" + containerId).html(html);
            }
            return html;
        }

        var username = "Admin"
        var password = ""

        function generic_exec_from_input(input_id, result_id, verb="GET")
        {


            $('#' + result_id).html('<div class="loader"></div>');
            $.ajax(
            {
                url: rootURL + $("#" + input_id).val(),
                type: verb
            }).fail(function(err)
            {
                $('#' + result_id).html("Status  : " + err["status"] + " - " + err["statusText"] + "\nMessage : " + err["responseText"]);
            }).done(function(json) 
            {
                $('#' + result_id).html(syntaxHighlight(json));
            })
        }
        function generic_exec_static(endpoint, result_id, input_id=false, verb="GET")
        {
            $('#' + result_id).html('<div class="loader"></div>');
            if (input_id)
            {
                $("#" + input_id).val(endpoint);
            }
            $.ajax(
            {
                url: rootURL + endpoint,
                type: verb
            }).fail(function(err)
            {
                $('#' + result_id).html("Status  : " + err["status"] + " - " + err["statusText"] + "\nMessage : " + err["responseText"]);
            }).done(function(json) 
            {
                $('#' + result_id).html(syntaxHighlight(json));
            })
        }
        function generic_exec_body(input_id, body_id, result_id, verb="POST")
        {
            $('#' + result_id).html('<div class="loader"></div>');
            $.ajax(
            {
                url: rootURL + $("#" + input_id).val(),
                type: verb,
                contentType: 'application/json',
                data: JSON.stringify($("#" + body_id).val())
            }).fail(function(err)
            {
                $('#' + result_id).html("Status  : " + err["status"] + " - " + err["statusText"] + "\nMessage : " + err["responseText"]);
            }).done(function(json) 
            {
                $('#' + result_id).html(syntaxHighlight(json));
            })
        }



        // FILE EXEC

        function exec_file_api_05_i()
        {
            $('#' + result_id).html('<div class="loader"></div>');
            $.ajax(
            {
                url: rootURL + "/file/" + RegovarFileUpload.url.split("/")[2],
                type: "GET"
            }).fail(function()
            {
                alert( "ERROR" );
            }).done(function(json) 
            {
                $('#file_result').html(syntaxHighlight(json));
            })
        }





        function refresh_job_panel()
        {
            alert("todo");
        }











        // WEBSOCKETS SESSION
        var ws = new WebSocket('ws://{{ hostname }}/ws');
        var $message = $('#ws_message');
        var $ico = $("#ws_ico");

        function ws_new_msg(sender, msg, data="")
        {
            if (msg == "error")
            {
                $ico.css("color", "orangered");
                $message.attr("class", 'label label-warning');
            }
            else if (msg == "close")
            {
                $ico.css("color", "lightgrey");
                $message.attr("class", 'label label-warning');
            }
            else
            {
                $ico.css("color", "lightgreen");
                $message.attr("class", 'label label-success');
            }

            var dt = new Date();
            var time = dt.getHours() + "h " + dt.getMinutes() + "m " + dt.getSeconds() + "s"

            $('#ws_logs').append("<tr><td>" + time + "</td><td>" + sender + "</td><td>" + msg + "</td><td>" + data + "</td></tr>");
        }

        function ws_onopen()
        {
            ws_new_msg("Regovar", "open")
        };
        function ws_onmessage(ev)
        {
            var json = JSON.parse(ev.data);
            ws_new_msg("Regovar", json["msg"], json["data"])

            switch(json["msg"])
            {
                case 'run_changed':
                    ws_run_changed(json["data"])
                    break;
                case 'file_changed':
                    ws_file_changed(json["data"])
                    break;
                case 'error':
                    ws_error(json["data"])
                    break;
            }
        };
        function ws_onclose(ev)
        {
            // Try to reconnect websocket every seconds
            ws_new_msg("Me", "close", ev.data)
            setTimeout(ws_setup, 1000);
        };
        function ws_onerror(ev)
        {
            ws_new_msg("Me", "error", ev.data)
        };
        function ws_setup()
        {
            $ico.css("color", "lightgrey");
            ws = new WebSocket('ws://{{ hostname }}/ws'); //new WebSocket((location.protocol == 'https:' ? 'wss://' : 'ws://') + '{{ hostname }}/ws');
            //ws.onerror = ws_onerror;
            ws.onopen = ws_onopen;
            ws.onmessage = ws_onmessage;
            ws.onclose = ws_onclose;
        }




        // TUS Client for File upload
        var RegovarFileUpload = null;
        var RegovarFileInput = document.querySelector("#file_api_05_localinput");
        var RegovarFileAlertBox = document.querySelector("#tus_support_alert");
        var RegovarFileChunkInput = document.querySelector("#file_api_05_chunksize");
        var RegovarFileEndpointInput = document.querySelector("#file_api_05_endpoint");

        if (!tus.isSupported) 
        {
            RegovarFileAlertBox.className = RegovarFileAlertBox.className.replace("hidden", "");
        }

        RegovarFileInput.addEventListener("change", function(e) 
        {
            var file = e.target.files[0];
            console.log("selected file", file);
            var endpoint = RegovarFileEndpointInput.value;
            var chunkSize = parseInt(RegovarFileChunkInput.value, 10);


            if (isNaN(chunkSize)) 
            {
                chunkSize = Infinity;
            }
            var options = {
                endpoint: endpoint,
                resume: true,
                chunkSize: chunkSize,
                metadata: { filename: file.name },
                onError: function(error) 
                {
                    RegovarFileInput.value = "";
                    alert("Failed because: " + error);
                },
                onProgress: function(bytesUploaded, bytesTotal) 
                {
                    var percentage = (bytesUploaded / bytesTotal * 100).toFixed(2);
                    console.log(bytesUploaded, bytesTotal, percentage + "%");
                    buildProgressBar(percentage, "file_api_05_progress");
                },
                onSuccess: function() 
                {
                    RegovarFileInput.value = "";
                    $("#file_api_05_progress").html("");

                }
            }

            RegovarFileUpload = new tus.Upload(file, options);
            RegovarFileUpload.start();
        })


        // ON DOCUMENT READY
        $(document).ready(function()
        {
            $('#json').text(syntaxHighlight(data));
        });

    </script>
</body>
</html>
